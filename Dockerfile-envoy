FROM    alpine:3.15.1 AS build

WORKDIR /app

RUN     apk add --no-cache protoc

COPY    ./proto/greeting.proto .
COPY    ./proto/todo.proto .

# build proto descriptor
RUN     protoc --include_imports --include_source_info \
    --descriptor_set_out=greeting.pb greeting.proto
RUN     protoc --include_imports --include_source_info \
    --descriptor_set_out=todo.pb todo.proto

FROM    envoyproxy/envoy:v1.22.0

COPY    --from=build /app/greeting.pb /tmp/
COPY    --from=build /app/todo.pb /tmp/